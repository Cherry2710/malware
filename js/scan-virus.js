const url = "https://www.virustotal.com/vtapi/v2/file"
const apikey = 'd696b69242cae6d76325eef42d0255e668dac5573dd823d031cce025e049faa6';

async function onScanVirus() {
    const fileScan = document.getElementById('fileScan');

    const formData = new FormData();
    formData.append('apikey', apikey);
    formData.append('file', fileScan.files[0]);
    $('#progress').show()
    console.log(formData);
    const response = await fetch(`${url}/scan`, {
        method: 'POST',
        body: formData
    });

    if (response.status == 200) {
        document.getElementById('exampleModalLabel').innerHTML = "Scan Successful!"     
        const data = await response.json();
        fetchReportScan(data['resource'])
    } else {
        document.getElementById('exampleModalLabel').innerHTML = "Scan Failed!"
        var img = document.getElementById('imgResult');
        var newImg = new Image();
        newImg.onload = function () {
            img.src = this.src
        }
        newImg.src = '../assets/img/fail.png';
    }
    $('#progress').hide()
    $('#scanModal').modal('show');
}

async function fetchReportScan(resource){
    const response = await fetch(`${url}/report?apikey=${apikey}&resource=${resource}&allinfo=false`)
    const data = await response.json();
    let result = "<div>";
    var isProtected = false;
    for(let x in data['scans']){
        if(data['scans'][x]['detected']){
            isProtected = true;
            result += x + ": " + data['scans'][x]['detected'] + "<br/>";
        }
    }
    result += "</div>";
    var img = document.getElementById('imgResult');
    var newImg = new Image();
    newImg.onload = function () {
        img.src = this.src
    }
    console.log(isProtected)
    if(!isProtected){
        newImg.src = '../assets/img/success.png';
        result = "<div>The file is Safe</div>";
    }else{
        newImg.src = '../assets/img/warning.png';
    }
    $('#result').empty()
    $('#result').append(result)
}

function hideModal() {
    $('#scanModal').modal('hide');
}
